<div class="company-management">
  <!-- Header -->
  <div class="header d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-1">Gestion des Entreprises</h1>
      <p class="text-muted mb-0">{{ totalCompanies }} entreprises</p>
    </div>

    <button class="btn btn-primary" (click)="createCompany()">
      <i class="bi bi-plus-lg me-2"></i>
      Nouvelle Entreprise
    </button>
  </div>

  <!-- Filtres -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              placeholder="Rechercher une entreprise..."
              [(ngModel)]="searchTerm"
              (input)="onSearchChange()"
            />
          </div>
        </div>

        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="statusFilter" (change)="onStatusChange()">
            <option value="">Tous les statuts</option>
            <option value="ACTIVE">Actif</option>
            <option value="TRIAL">Période d'essai</option>
            <option value="EXPIRED">Expiré</option>
            <option value="INACTIVE">Inactif</option>
          </select>
        </div>

        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="planFilter" (change)="onPlanChange()">
            <option value="">Tous les plans</option>
            <option value="STARTER">Starter</option>
            <option value="PRO">Pro</option>
            <option value="ENTERPRISE">Enterprise</option>
          </select>
        </div>

        <div class="col-md-2">
          <button class="btn btn-outline-secondary w-100" (click)="resetFilters()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Reset
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
  </div>

  <!-- Erreur -->
  <div *ngIf="!loading && errorMsg" class="alert alert-danger">
    {{ errorMsg }}
  </div>

  <!-- Table -->
  <div *ngIf="!loading && !errorMsg" class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="border-0 ps-4">Entreprise</th>
              <th class="border-0">Plan</th>
              <th class="border-0">Statut</th>
              <th class="border-0">Revenus/mois</th>
              <th class="border-0">Employés</th>
              <th class="border-0">Sites</th>
              <th class="border-0">Dernière connexion</th>
              <th class="border-0 text-end pe-4">Actions</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let company of companies; trackBy: trackById"
                [class.table-warning]="!company.isActive">
              <td class="ps-4">
                <div class="d-flex align-items-center">
                  <div class="avatar bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3">
                    <span class="text-white fw-bold">{{ getCompanyInitials(company.name) }}</span>
                  </div>
                  <div>
                    <h6 class="mb-1">{{ company.name }}</h6>
                    <small class="text-muted">{{ company.email }}</small>
                  </div>
                </div>
              </td>

              <td>
                <span class="badge"
                      [ngClass]="planBadgeClass(company?.subscriptionPlan)">
                  {{ company?.subscriptionPlan ?? '—' }}
                </span>
              </td>

              <td>
                <span class="badge"
                      [ngClass]="{
                        'bg-success': company.subscriptionStatus === 'ACTIVE',
                        'bg-warning': company.subscriptionStatus === 'TRIAL',
                        'bg-danger': company.subscriptionStatus === 'EXPIRED',
                        'bg-secondary': company.subscriptionStatus === 'INACTIVE'
                      }">
                  {{ getStatusLabel(company.subscriptionStatus) }}
                </span>
              </td>

              <td>
                <span class="fw-bold">
                  {{ company.monthlyRevenue | currency:'EUR':'symbol':'1.0-0' }}
                </span>
              </td>

              <td>
                <span class="badge bg-light text-dark">{{ company.employeesCount }}</span>
              </td>

              <td>
                <span class="badge bg-light text-dark">{{ company.sitesCount }}</span>
              </td>

              <td>
                <small class="text-muted">
                  {{ company.lastLoginAt ? (company.lastLoginAt | date:'dd/MM/yyyy') : 'Jamais' }}
                </small>
              </td>

              <td class="text-end pe-4">
                <div class="dropdown">
                  <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Actions
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" [routerLink]="['/platform-admin/companies', company.id]">
                        <i class="bi bi-eye me-2"></i>
                        Voir détails
                      </a>
                    </li>
                    <li>
                      <button class="dropdown-item" (click)="toggleCompanyStatus(company)">
                        <i class="bi"
                           [class.bi-play-circle]="!company.isActive"
                           [class.bi-pause-circle]="company.isActive"></i>
                        {{ company.isActive ? 'Désactiver' : 'Activer' }}
                      </button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <button class="dropdown-item text-danger" (click)="deleteCompany(company)">
                        <i class="bi bi-trash me-2"></i>
                        Supprimer
                      </button>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>

            <!-- Aucune donnée -->
            <tr *ngIf="!loading && companies.length === 0">
              <td colspan="8" class="text-center py-4 text-muted">
                Aucune entreprise trouvée.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav class="mt-4" *ngIf="!loading && totalCompanies > pageSize">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 0">
        <button class="page-link" (click)="changePage(currentPage - 1)">Précédent</button>
      </li>

      <li *ngFor="let page of getPageNumbers()"
          class="page-item"
          [class.active]="page === currentPage">
        <button class="page-link" (click)="changePage(page)">{{ page + 1 }}</button>
      </li>

      <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
        <button class="page-link" (click)="changePage(currentPage + 1)">Suivant</button>
      </li>
    </ul>
  </nav>
</div>
